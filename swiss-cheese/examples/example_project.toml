# Swiss Cheese Model - Software Design Document
# This TOML file defines requirements, verification tasks, and gate configurations
# for production software development with the 9-layer Swiss Cheese Model.
#
# Usage:
# 1. Copy this file to your project root as `design.toml`
# 2. Copy Makefile.swiss-cheese to `Makefile` and customize
# 3. Run `/swiss-cheese` to start orchestration
# 4. The orchestrator validates gates via Makefile targets

[project]
name = "example-production-system"
version = "0.1.0"
description = "Example project demonstrating Swiss Cheese verification model"
max_iterations = 5          # Max retries per task before failing
max_parallel_agents = 4     # Max concurrent subagents

# =============================================================================
# REQUIREMENTS
# Each requirement has a unique ID, testable criteria, and traceability info
# =============================================================================

[[requirements]]
id = "REQ-001"
title = "Safe Input Parsing"
description = "The system must safely parse untrusted input without panics or undefined behavior"
priority = "critical"
acceptance_criteria = [
    "All input parsing functions handle malformed input gracefully",
    "No panics on any valid or invalid input",
    "Property-based tests cover edge cases",
    "Miri finds no undefined behavior",
]
traces_to = ["REQ-002"]

[[requirements]]
id = "REQ-002"
title = "Memory Safety"
description = "All operations must be memory-safe with no leaks or use-after-free"
priority = "critical"
acceptance_criteria = [
    "Zero unsafe blocks, or all unsafe blocks justified and audited",
    "Miri passes on all tests",
    "cargo-geiger reports acceptable unsafe usage",
]

[[requirements]]
id = "REQ-003"
title = "Bounded Resource Usage"
description = "CPU and memory usage must be bounded and predictable"
priority = "high"
acceptance_criteria = [
    "No unbounded allocations",
    "All loops have provable termination",
    "Stack usage is bounded",
]

[[requirements]]
id = "REQ-004"
title = "Error Handling"
description = "All errors must be handled explicitly without silent failures"
priority = "high"
acceptance_criteria = [
    "No unwrap() or expect() in production code",
    "All Result types are handled",
    "Error messages are informative",
]

[[requirements]]
id = "REQ-005"
title = "Test Coverage"
description = "Code must have comprehensive test coverage"
priority = "medium"
acceptance_criteria = [
    "Line coverage >= 80%",
    "All public APIs have unit tests",
    "Integration tests cover main workflows",
]

# =============================================================================
# TASKS
# Tasks are organized by layer with explicit dependencies
# Each task references requirements it addresses
# =============================================================================

[tasks.parse_requirements]
layer = "requirements"
description = "Parse and validate requirement specifications from this document"
depends_on = []
requirements = ["REQ-001", "REQ-002", "REQ-003", "REQ-004", "REQ-005"]
agent = "requirements-agent"

[tasks.formalize_constraints]
layer = "requirements"
description = "Formalize type and ownership constraints for each requirement"
depends_on = ["parse_requirements"]
requirements = ["REQ-002", "REQ-003"]
agent = "requirements-agent"

[tasks.design_modules]
layer = "architecture"
description = "Design module structure with clear ownership boundaries"
depends_on = ["formalize_constraints"]
requirements = ["REQ-002"]
agent = "architecture-agent"

[tasks.define_interfaces]
layer = "architecture"
description = "Define public interfaces and trait contracts"
depends_on = ["design_modules"]
requirements = ["REQ-001", "REQ-004"]
agent = "architecture-agent"

[tasks.write_unit_tests]
layer = "tdd"
description = "Write unit tests for all public interfaces"
depends_on = ["define_interfaces"]
requirements = ["REQ-005"]
agent = "tdd-agent"

[tasks.write_property_tests]
layer = "tdd"
description = "Write property-based tests with proptest for edge cases"
depends_on = ["define_interfaces"]
requirements = ["REQ-001", "REQ-005"]
agent = "tdd-agent"

[tasks.implement_core]
layer = "implementation"
description = "Implement core functionality to pass all tests"
depends_on = ["write_unit_tests", "write_property_tests"]
requirements = ["REQ-001", "REQ-002", "REQ-004"]
agent = "implementation-agent"

[tasks.run_clippy]
layer = "static_analysis"
description = "Run clippy with all warnings as errors"
depends_on = ["implement_core"]
requirements = ["REQ-002", "REQ-004"]
agent = "static-analysis-agent"
command = "cargo clippy --all-targets --all-features -- -D warnings"

[tasks.run_cargo_audit]
layer = "static_analysis"
description = "Audit dependencies for security vulnerabilities"
depends_on = ["implement_core"]
requirements = ["REQ-002"]
agent = "static-analysis-agent"
command = "cargo audit"

[tasks.audit_unsafe]
layer = "static_analysis"
description = "Audit all unsafe blocks with justification"
depends_on = ["implement_core"]
requirements = ["REQ-002"]
agent = "static-analysis-agent"
command = "cargo geiger --all-features"

[tasks.run_miri]
layer = "dynamic_analysis"
description = "Run Miri for undefined behavior detection"
depends_on = ["implement_core"]
requirements = ["REQ-001", "REQ-002"]
agent = "dynamic-analysis-agent"
command = "cargo +nightly miri test"

[tasks.measure_coverage]
layer = "dynamic_analysis"
description = "Measure test coverage with cargo-llvm-cov"
depends_on = ["implement_core"]
requirements = ["REQ-005"]
agent = "dynamic-analysis-agent"
command = "cargo llvm-cov --all-features --json --output-path coverage.json"

[tasks.run_kani]
layer = "formal_verification"
description = "Run Kani model checker on critical functions"
depends_on = ["run_clippy"]
requirements = ["REQ-003"]
agent = "formal-verification-agent"
command = "cargo kani"

[tasks.independent_review]
layer = "review"
description = "Fresh-eyes code review by independent agent"
depends_on = ["run_clippy", "run_cargo_audit", "measure_coverage"]
requirements = ["REQ-001", "REQ-002", "REQ-003", "REQ-004"]
agent = "review-agent"

[tasks.assemble_safety_case]
layer = "safety"
description = "Compile all verification evidence into safety case"
depends_on = ["independent_review", "run_kani"]
requirements = ["REQ-001", "REQ-002", "REQ-003", "REQ-004", "REQ-005"]
agent = "safety-agent"

# =============================================================================
# GATES
# Gate configurations with Makefile targets for validation
# =============================================================================

[gates.requirements]
target = "validate-requirements"

[gates.architecture]
target = "validate-architecture"

[gates.tdd]
target = "validate-tdd"

[gates.implementation]
target = "validate-implementation"

[gates.static_analysis]
target = "validate-static-analysis"
fail_fast = true

[gates.formal_verification]
target = "validate-formal-verification"

[gates.dynamic_analysis]
target = "validate-dynamic-analysis"
min_coverage = 80

[gates.review]
target = "validate-review"

[gates.safety]
target = "validate-safety-case"

# =============================================================================
# TRACEABILITY
# Configuration for requirement-to-test traceability
# =============================================================================

[traceability]
enabled = true
report_formats = ["json", "html"]
test_pattern = "test_req_\\d+.*"  # Tests should be named test_req_001_*, etc.
